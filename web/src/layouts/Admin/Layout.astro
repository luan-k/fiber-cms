---
import Page from "./Page.astro"
import AdminSidebar from "./Sidebar.astro";
import { SITE_TITLE } from "@/consts";

interface Props {
  title: string;
  description?: string;
}

const { title, description = "Admin interface for Go Live CMS" } = Astro.props;
---

<Page title={`${title} - ${SITE_TITLE}`} {description} >
  <Fragment slot="head">
    <script is:inline>
      if (typeof window !== 'undefined') {
        const token = localStorage.getItem('access_token');
        if (!token) {
          const currentPath = window.location.pathname;
          window.location.href = `/login?redirect=${encodeURIComponent(currentPath)}`;
        }
      }
    </script>
  </Fragment>

  <main id="admin">
    <AdminSidebar />
    <section class="admin-main">
      <div id="admin-content">
        <slot />
      </div>
    </section>
  </main>

  <Fragment slot="foot">
    <script>
      import { authManager } from "@/lib/auth";

      document.addEventListener('DOMContentLoaded', async () => {
        const authState = authManager.getState();
        if (!authState.isAuthenticated) {
          // TODO: add a loading spinner in a component.
          document.getElementById("admin-content")!.innerHTML =
            "<div style='text-align: center; padding: 2rem;'>Redirecting to login...</div>";

          setTimeout(() => {
            const currentPath = window.location.pathname;
            window.location.href = `/login?redirect=${encodeURIComponent(currentPath)}`;
          }, 1000);
          return;
        }

        if (authState.refreshToken) {
          try {
            await authManager.refreshAccessToken();
          } catch (error) {
            console.log('Token refresh failed, redirecting to login');
            const currentPath = window.location.pathname;
            window.location.href = `/login?redirect=${encodeURIComponent(currentPath)}`;
          }
        }
      });

      window.addEventListener('unhandledrejection', (event) => {
        if (event.reason?.message?.includes('Authentication required')) {
          console.log('Global auth error detected, redirecting to login');
          event.preventDefault(); 
          const currentPath = window.location.pathname;
          window.location.href = `/login?redirect=${encodeURIComponent(currentPath)}`;
        }
      });
    </script>
  </Fragment>
</Page>